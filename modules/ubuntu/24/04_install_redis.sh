#!/bin/bash

# =============================================================================
# Module 04: CÃ i Ä‘áº·t Redis (04_install_redis.sh)
# Má»¥c tiÃªu: CÃ i Ä‘áº·t vÃ  cáº¥u hÃ¬nh Redis server vá»›i cÃ¡c tá»‘i Æ°u hÃ³a
# =============================================================================

set -e

# Import cáº¥u hÃ¬nh
source "$(dirname "$(dirname "$(dirname "${BASH_SOURCE[0]}")")")/config.sh"

log_info "=== BÆ¯á»šC 5: CÃ€I Äáº¶T REDIS ==="

# CÃ i Ä‘áº·t Redis server
log_info "CÃ i Ä‘áº·t Redis Server..."
apt install -y redis-server

# Backup cáº¥u hÃ¬nh gá»‘c
cp /etc/redis/redis.conf "$BACKUP_DIR/redis.conf.bak"

# Cáº¥u hÃ¬nh Redis
log_info "Cáº¥u hÃ¬nh Redis..."

cat > /etc/redis/redis.conf << EOF
# Redis Configuration
# Generated by VPS Management Script

# Network
bind $REDIS_BIND_ADDRESS
port $REDIS_PORT
protected-mode yes
tcp-backlog 511
timeout 0
tcp-keepalive 300

# General
daemonize yes
pidfile /var/run/redis/redis-server.pid
loglevel notice
logfile /var/log/redis/redis-server.log
databases 16

# Security
requirepass $(generate_password 32)

# Memory management
maxmemory $REDIS_MAXMEMORY
maxmemory-policy $REDIS_MAXMEMORY_POLICY

# Persistence
save 900 1
save 300 10
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /var/lib/redis

# Replication
# slave-serve-stale-data yes
# slave-read-only yes

# Append only file
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes

# Lua scripting
lua-time-limit 5000

# Slow log
slowlog-log-slower-than 10000
slowlog-max-len 128

# Latency monitoring
latency-monitor-threshold 100

# Event notification
notify-keyspace-events ""

# Advanced config
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000
stream-node-max-bytes 4096
stream-node-max-entries 100
activerehashing yes
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60
hz 10
dynamic-hz yes
aof-rewrite-incremental-fsync yes
rdb-save-incremental-fsync yes
EOF

# Láº¥y password tá»« file cáº¥u hÃ¬nh
REDIS_PASSWORD=$(grep "^requirepass" /etc/redis/redis.conf | awk '{print $2}')

# Cáº¥u hÃ¬nh systemd override cho Redis
mkdir -p /etc/systemd/system/redis-server.service.d
cat > /etc/systemd/system/redis-server.service.d/override.conf << 'EOF'
[Service]
# Restart Redis automatically
Restart=always
RestartSec=3

# Security settings
NoNewPrivileges=yes
PrivateTmp=yes
PrivateDevices=yes
ProtectHome=yes
ProtectSystem=strict
ReadWritePaths=/var/lib/redis
ReadWritePaths=/var/log/redis
ReadWritePaths=/var/run/redis

# Resource limits
LimitNOFILE=65535
EOF

# Reload systemd vÃ  restart Redis
systemctl daemon-reload
systemctl enable redis-server
systemctl restart redis-server

# Kiá»ƒm tra tráº¡ng thÃ¡i Redis
if systemctl is-active --quiet redis-server; then
    log_success "Redis Server Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t vÃ  khá»Ÿi Ä‘á»™ng thÃ nh cÃ´ng!"
else
    log_error "Lá»—i khá»Ÿi Ä‘á»™ng Redis Server!"
    exit 1
fi

# CÃ i Ä‘áº·t Redis PHP extension cho táº¥t cáº£ phiÃªn báº£n PHP
log_info "CÃ i Ä‘áº·t Redis PHP extension..."

for version in "${PHP_VERSIONS[@]}"; do
    apt install -y "php$version-redis"
    
    # Cáº¥u hÃ¬nh Redis extension
    cat > "/etc/php/$version/mods-available/redis.ini" << 'EOF'
; configuration for php redis module
; priority=20
extension=redis.so

; Redis session handler
;session.save_handler = redis
;session.save_path = "tcp://127.0.0.1:6379?auth=your_password"
EOF

    # Restart PHP-FPM
    systemctl restart "php$version-fpm"
    
    log_success "Redis extension Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t cho PHP $version"
done

# Táº¡o script Redis CLI vá»›i authentication
cat > /usr/local/bin/redis-cli-auth << EOF
#!/bin/bash

# Redis CLI with automatic authentication
# Usage: redis-cli-auth [redis-cli options]

redis-cli -a "$REDIS_PASSWORD" "\$@"
EOF

chmod +x /usr/local/bin/redis-cli-auth

# Táº¡o script giÃ¡m sÃ¡t Redis
cat > /usr/local/bin/redis-monitor << 'EOF'
#!/bin/bash

# Redis monitoring script
echo "=== Redis Server Status ==="

if systemctl is-active --quiet redis-server; then
    echo "Status: ðŸŸ¢ Running"
else
    echo "Status: ðŸ”´ Stopped"
    exit 1
fi

echo ""
echo "=== Redis Info ==="
redis-cli -a "$REDIS_PASSWORD" info server | grep -E "redis_version|uptime_in_seconds|connected_clients"

echo ""
echo "=== Memory Usage ==="
redis-cli -a "$REDIS_PASSWORD" info memory | grep -E "used_memory_human|used_memory_peak_human|maxmemory_human"

echo ""
echo "=== Keyspace ==="
redis-cli -a "$REDIS_PASSWORD" info keyspace

echo ""
echo "=== Recent Slow Queries ==="
redis-cli -a "$REDIS_PASSWORD" slowlog get 5
EOF

# Thay tháº¿ password placeholder trong script monitor
sed -i "s/\$REDIS_PASSWORD/$REDIS_PASSWORD/g" /usr/local/bin/redis-monitor
chmod +x /usr/local/bin/redis-monitor

# Táº¡o script backup Redis
cat > /root/backup_redis.sh << EOF
#!/bin/bash

# Redis backup script
BACKUP_DIR="/root/my-super-script/backups/redis"
DATE=\$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=7

# Táº¡o thÆ° má»¥c backup
mkdir -p "\$BACKUP_DIR"

# Backup Redis data
redis-cli -a "$REDIS_PASSWORD" BGSAVE
sleep 5

# Copy RDB file
cp /var/lib/redis/dump.rdb "\$BACKUP_DIR/redis_backup_\$DATE.rdb"

# Compress backup
gzip "\$BACKUP_DIR/redis_backup_\$DATE.rdb"

# XÃ³a backup cÅ©
find "\$BACKUP_DIR" -name "*.rdb.gz" -mtime +\$RETENTION_DAYS -delete

echo "Redis backup hoÃ n táº¥t: \$BACKUP_DIR/redis_backup_\$DATE.rdb.gz"
EOF

chmod +x /root/backup_redis.sh

# ThÃªm cron job backup Redis hÃ ng ngÃ y (3:00 AM)
(crontab -l 2>/dev/null; echo "0 3 * * * /root/backup_redis.sh >> /var/log/redis_backup.log 2>&1") | crontab -

# Táº¡o logrotate cho Redis
cat > /etc/logrotate.d/redis-server << 'EOF'
/var/log/redis/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 640 redis redis
    sharedscripts
    postrotate
        systemctl reload redis-server
    endscript
}
EOF

# Test káº¿t ná»‘i Redis
log_info "Test káº¿t ná»‘i Redis..."
if redis-cli -a "$REDIS_PASSWORD" ping > /dev/null 2>&1; then
    log_success "âœ… Redis káº¿t ná»‘i thÃ nh cÃ´ng!"
else
    log_error "âŒ Lá»—i káº¿t ná»‘i Redis!"
    exit 1
fi

# Test Redis vá»›i PHP
log_info "Test Redis vá»›i PHP..."
for version in "${PHP_VERSIONS[@]}"; do
    if "/usr/bin/php$version" -m | grep -q redis; then
        log_success "âœ… Redis extension hoáº¡t Ä‘á»™ng vá»›i PHP $version"
    else
        log_warning "âš ï¸ Redis extension khÃ´ng hoáº¡t Ä‘á»™ng vá»›i PHP $version"
    fi
done

# Ghi thÃ´ng tin vÃ o credentials file
cat >> "$CREDENTIALS_FILE" << EOF

# Redis Configuration
REDIS_HOST=$REDIS_BIND_ADDRESS
REDIS_PORT=$REDIS_PORT
REDIS_PASSWORD=$REDIS_PASSWORD
REDIS_VERSION=\$(redis-server --version | awk '{print \$3}' | cut -d'=' -f2)

# Redis Tools
REDIS_CLI_AUTH=/usr/local/bin/redis-cli-auth
REDIS_MONITOR=/usr/local/bin/redis-monitor
REDIS_BACKUP_SCRIPT=/root/backup_redis.sh

# Redis Files
REDIS_CONFIG=/etc/redis/redis.conf
REDIS_DATA_DIR=/var/lib/redis
REDIS_LOG_FILE=/var/log/redis/redis-server.log

# Connection strings for applications
REDIS_URL=redis://:$REDIS_PASSWORD@$REDIS_BIND_ADDRESS:$REDIS_PORT/0

EOF

log_success "Module Redis hoÃ n táº¥t!"
log_info "Redis Server Ä‘ang cháº¡y trÃªn $REDIS_BIND_ADDRESS:$REDIS_PORT"
log_info "Password: $REDIS_PASSWORD"
log_info "CÃ¡c cÃ´ng cá»¥ cÃ³ sáºµn:"
log_info "  - redis-cli-auth        : Redis CLI vá»›i authentication"
log_info "  - redis-monitor         : GiÃ¡m sÃ¡t Redis"

# Hiá»ƒn thá»‹ thÃ´ng tin Redis
echo ""
echo "=== ThÃ´ng tin Redis ==="
redis-cli -a "$REDIS_PASSWORD" info server | grep redis_version
echo "Memory limit: $REDIS_MAXMEMORY"
echo "Policy: $REDIS_MAXMEMORY_POLICY"
